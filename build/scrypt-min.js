var PBKDF=require("./pbkdf2"),hexer=require("./sjcl").codec.hex,crypto=require("crypto"),util=require("util"),MAX_VALUE=2147483647;
function scrypt(a,c,b,d,e,f){if(0==b||0!=(b&b-1))throw Error("N must be \x3e 0 and a power of 2");if(b>MAX_VALUE/128/d)throw Error("Parameter N is too large");if(d>MAX_VALUE/128/e)throw Error("Parameter r is too large");var g=[],h=[],k=[],l=[];PBKDF(a,new Buffer(c,encoding="utf8"),1,h,128*e*d);for(c=0;c<e;c++)smix(h,128*c*d,d,b,l,k);PBKDF(a,h,1,g,f);return(new Buffer(g)).toString("base64")}
function smix(a,c,b,d,e,f){var g=128*b,h;arraycopy(a,c,f,0,g);for(h=0;h<d;h++)arraycopy(f,0,e,h*g,g),blockmix_salsa8(f,0,g,b);for(h=0;h<d;h++){var k=integerify(f,0,b)&d-1;blockxor(e,k*g,f,0,g);blockmix_salsa8(f,0,g,b)}arraycopy(f,0,a,c,g)}
function blockmix_salsa8(a,c,b,d){var e=[],f;arraycopy32(a,c+64*(2*d-1),e,0,64);for(f=0;f<2*d;f++)blockxor(a,64*f,e,0,64),salsa20_8(e),arraycopy32(e,0,a,b+64*f,64);for(f=0;f<d;f++)arraycopy32(a,b+128*f,a,c+64*f,64);for(f=0;f<d;f++)arraycopy32(a,b+64*(2*f+1),a,c+64*(f+d),64)}function R(a,c){return a<<c|a>>>32-c}
function salsa20_8(a){var c=Array(32),b=Array(32),d;for(d=0;16>d;d++)c[d]=(a[4*d+0]&255)<<0,c[d]|=(a[4*d+1]&255)<<8,c[d]|=(a[4*d+2]&255)<<16,c[d]|=(a[4*d+3]&255)<<24;arraycopy(c,0,b,0,16);for(d=8;0<d;d-=2)b[4]^=R(b[0]+b[12],7),b[8]^=R(b[4]+b[0],9),b[12]^=R(b[8]+b[4],13),b[0]^=R(b[12]+b[8],18),b[9]^=R(b[5]+b[1],7),b[13]^=R(b[9]+b[5],9),b[1]^=R(b[13]+b[9],13),b[5]^=R(b[1]+b[13],18),b[14]^=R(b[10]+b[6],7),b[2]^=R(b[14]+b[10],9),b[6]^=R(b[2]+b[14],13),b[10]^=R(b[6]+b[2],18),b[3]^=R(b[15]+b[11],7),b[7]^=
R(b[3]+b[15],9),b[11]^=R(b[7]+b[3],13),b[15]^=R(b[11]+b[7],18),b[1]^=R(b[0]+b[3],7),b[2]^=R(b[1]+b[0],9),b[3]^=R(b[2]+b[1],13),b[0]^=R(b[3]+b[2],18),b[6]^=R(b[5]+b[4],7),b[7]^=R(b[6]+b[5],9),b[4]^=R(b[7]+b[6],13),b[5]^=R(b[4]+b[7],18),b[11]^=R(b[10]+b[9],7),b[8]^=R(b[11]+b[10],9),b[9]^=R(b[8]+b[11],13),b[10]^=R(b[9]+b[8],18),b[12]^=R(b[15]+b[14],7),b[13]^=R(b[12]+b[15],9),b[14]^=R(b[13]+b[12],13),b[15]^=R(b[14]+b[13],18);for(d=0;16>d;++d)c[d]=b[d]+c[d];for(d=0;16>d;d++)b=4*d,a[b+0]=c[d]>>0&255,a[b+
1]=c[d]>>8&255,a[b+2]=c[d]>>16&255,a[b+3]=c[d]>>24&255}
function blockxor(a,c,b,d,e){for(e>>=6;e--;)b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=
a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++],b[d++]^=a[c++]}
function integerify(a,c,b){c+=64*(2*b-1);b=(a[c+0]&255)<<0;b|=(a[c+1]&255)<<8;b|=(a[c+2]&255)<<16;return b|=(a[c+3]&255)<<24}function arraycopy(a,c,b,d,e){for(;e--;)b[d++]=a[c++]}function arraycopy16(a,c,b,d,e){for(e>>=4;e--;)b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++]}
function arraycopy32(a,c,b,d,e){for(e>>=5;e--;)b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++],b[d++]=a[c++]}
exports.scrypt=scrypt;if(process.argv[1]==__filename){var t1=new Date;console.log("hashing...");var spass=scrypt("hello","C/EaaeFElPd6f2o93GlrVA\x3d\x3d",32,8,8,32);console.log("Scrypt: "+(new Date-t1)+" ms");console.log("Password encrypted "+spass)}"use strict";
var sjcl={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(a){this.toString=function(){return"CORRUPT: "+this.message};this.message=a},invalid:function(a){this.toString=function(){return"INVALID: "+this.message};this.message=a},bug:function(a){this.toString=function(){return"BUG: "+this.message};this.message=a},notReady:function(a){this.toString=function(){return"NOT READY: "+this.message};this.message=a}}};
sjcl.cipher.aes=function(a){this.h[0][0][0]||this.w();var c,b,d,e,f=this.h[0][4],g=this.h[1];c=a.length;var h=1;if(4!==c&&6!==c&&8!==c)throw new sjcl.exception.invalid("invalid aes key size");this.a=[d=a.slice(0),e=[]];for(a=c;a<4*c+28;a++){b=d[a-1];if(0===a%c||8===c&&4===a%c)b=f[b>>>24]<<24^f[b>>16&255]<<16^f[b>>8&255]<<8^f[b&255],0===a%c&&(b=b<<8^b>>>24^h<<24,h=h<<1^283*(h>>7));d[a]=d[a-c]^b}for(c=0;a;c++,a--)b=d[c&3?a:a-4],e[c]=4>=a||4>c?b:g[0][f[b>>>24]]^g[1][f[b>>16&255]]^g[2][f[b>>8&255]]^g[3][f[b&
255]]};
sjcl.cipher.aes.prototype={encrypt:function(a){return this.H(a,0)},decrypt:function(a){return this.H(a,1)},h:[[[],[],[],[],[]],[[],[],[],[],[]]],w:function(){var a=this.h[0],c=this.h[1],b=a[4],d=c[4],e,f,g,h=[],k=[],l,m,n,p;for(e=0;256>e;e++)k[(h[e]=e<<1^283*(e>>7))^e]=e;for(f=g=0;!b[f];f^=l||1,g=k[g]||1){n=g^g<<1^g<<2^g<<3^g<<4;n=n>>8^n&255^99;b[f]=n;d[n]=f;m=h[e=h[l=h[f]]];p=16843009*m^65537*e^257*l^16843008*f;m=257*h[n]^16843008*n;for(e=0;4>e;e++)a[e][f]=m=m<<24^m>>>8,c[e][n]=p=p<<24^p>>>8}for(e=
0;5>e;e++)a[e]=a[e].slice(0),c[e]=c[e].slice(0)},H:function(a,c){if(4!==a.length)throw new sjcl.exception.invalid("invalid aes block size");var b=this.a[c],d=a[0]^b[0],e=a[c?3:1]^b[1],f=a[2]^b[2];a=a[c?1:3]^b[3];var g,h,k,l=b.length/4-2,m,n=4,p=[0,0,0,0];g=this.h[c];var q=g[0],r=g[1],u=g[2],v=g[3],w=g[4];for(m=0;m<l;m++)g=q[d>>>24]^r[e>>16&255]^u[f>>8&255]^v[a&255]^b[n],h=q[e>>>24]^r[f>>16&255]^u[a>>8&255]^v[d&255]^b[n+1],k=q[f>>>24]^r[a>>16&255]^u[d>>8&255]^v[e&255]^b[n+2],a=q[a>>>24]^r[d>>16&255]^
u[e>>8&255]^v[f&255]^b[n+3],n+=4,d=g,e=h,f=k;for(m=0;4>m;m++)p[c?3&-m:m]=w[d>>>24]<<24^w[e>>16&255]<<16^w[f>>8&255]<<8^w[a&255]^b[n++],g=d,d=e,e=f,f=a,a=g;return p}};
sjcl.bitArray={bitSlice:function(a,c,b){a=sjcl.bitArray.P(a.slice(c/32),32-(c&31)).slice(1);return void 0===b?a:sjcl.bitArray.clamp(a,b-c)},extract:function(a,c,b){var d=Math.floor(-c-b&31);return((c+b-1^c)&-32?a[c/32|0]<<32-d^a[c/32+1|0]>>>d:a[c/32|0]>>>d)&(1<<b)-1},concat:function(a,c){if(0===a.length||0===c.length)return a.concat(c);var b=a[a.length-1],d=sjcl.bitArray.getPartial(b);return 32===d?a.concat(c):sjcl.bitArray.P(c,d,b|0,a.slice(0,a.length-1))},bitLength:function(a){var c=a.length;return 0===
c?0:32*(c-1)+sjcl.bitArray.getPartial(a[c-1])},clamp:function(a,c){if(32*a.length<c)return a;a=a.slice(0,Math.ceil(c/32));var b=a.length;c&=31;0<b&&c&&(a[b-1]=sjcl.bitArray.partial(c,a[b-1]&2147483648>>c-1,1));return a},partial:function(a,c,b){return 32===a?c:(b?c|0:c<<32-a)+1099511627776*a},getPartial:function(a){return Math.round(a/1099511627776)||32},equal:function(a,c){if(sjcl.bitArray.bitLength(a)!==sjcl.bitArray.bitLength(c))return!1;var b=0,d;for(d=0;d<a.length;d++)b|=a[d]^c[d];return 0===
b},P:function(a,c,b,d){var e;for(void 0===d&&(d=[]);32<=c;c-=32)d.push(b),b=0;if(0===c)return d.concat(a);for(e=0;e<a.length;e++)d.push(b|a[e]>>>c),b=a[e]<<32-c;e=a.length?a[a.length-1]:0;a=sjcl.bitArray.getPartial(e);d.push(sjcl.bitArray.partial(c+a&31,32<c+a?b:d.pop(),1));return d},k:function(a,c){return[a[0]^c[0],a[1]^c[1],a[2]^c[2],a[3]^c[3]]}};
sjcl.codec.utf8String={fromBits:function(a){var c="",b=sjcl.bitArray.bitLength(a),d,e;for(d=0;d<b/8;d++)0===(d&3)&&(e=a[d/4]),c+=String.fromCharCode(e>>>24),e<<=8;return decodeURIComponent(escape(c))},toBits:function(a){a=unescape(encodeURIComponent(a));var c=[],b,d=0;for(b=0;b<a.length;b++)d=d<<8|a.charCodeAt(b),3===(b&3)&&(c.push(d),d=0);b&3&&c.push(sjcl.bitArray.partial(8*(b&3),d));return c}};
sjcl.codec.hex={fromBits:function(a){var c="",b;for(b=0;b<a.length;b++)c+=((a[b]|0)+0xf00000000000).toString(16).substr(4);return c.substr(0,sjcl.bitArray.bitLength(a)/4)},toBits:function(a){var c,b=[],d;a=a.replace(/\s|0x/g,"");d=a.length;a+="00000000";for(c=0;c<a.length;c+=8)b.push(parseInt(a.substr(c,8),16)^0);return sjcl.bitArray.clamp(b,4*d)}};
sjcl.codec.base64={D:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(a,c,b){var d="",e=0,f=sjcl.codec.base64.D,g=0,h=sjcl.bitArray.bitLength(a);b&&(f=f.substr(0,62)+"-_");for(b=0;6*d.length<h;)d+=f.charAt((g^a[b]>>>e)>>>26),6>e?(g=a[b]<<6-e,e+=26,b++):(g<<=6,e-=6);for(;d.length&3&&!c;)d+="\x3d";return d},toBits:function(a,c){a=a.replace(/\s|=/g,"");var b=[],d=0,e=sjcl.codec.base64.D,f=0,g;c&&(e=e.substr(0,62)+"-_");for(c=0;c<a.length;c++){g=e.indexOf(a.charAt(c));
if(0>g)throw new sjcl.exception.invalid("this isn't base64!");26<d?(d-=26,b.push(f^g>>>d),f=g<<32-d):(d+=6,f^=g<<32-d)}d&56&&b.push(sjcl.bitArray.partial(d&56,f,1));return b}};sjcl.codec.base64url={fromBits:function(a){return sjcl.codec.base64.fromBits(a,1,1)},toBits:function(a){return sjcl.codec.base64.toBits(a,1)}};sjcl.hash.sha256=function(a){this.a[0]||this.w();a?(this.n=a.n.slice(0),this.i=a.i.slice(0),this.e=a.e):this.reset()};sjcl.hash.sha256.hash=function(a){return(new sjcl.hash.sha256).update(a).finalize()};
sjcl.hash.sha256.prototype={blockSize:512,reset:function(){this.n=this.N.slice(0);this.i=[];this.e=0;return this},update:function(a){"string"===typeof a&&(a=sjcl.codec.utf8String.toBits(a));var c,b=this.i=sjcl.bitArray.concat(this.i,a);c=this.e;a=this.e=c+sjcl.bitArray.bitLength(a);for(c=512+c&-512;c<=a;c+=512)this.C(b.splice(0,16));return this},finalize:function(){var a,c=this.i,b=this.n,c=sjcl.bitArray.concat(c,[sjcl.bitArray.partial(1,1)]);for(a=c.length+2;a&15;a++)c.push(0);c.push(Math.floor(this.e/
4294967296));for(c.push(this.e|0);c.length;)this.C(c.splice(0,16));this.reset();return b},N:[],a:[],w:function(){function a(a){return 4294967296*(a-Math.floor(a))|0}var c=0,b=2,d;a:for(;64>c;b++){for(d=2;d*d<=b;d++)if(0===b%d)continue a;8>c&&(this.N[c]=a(Math.pow(b,0.5)));this.a[c]=a(Math.pow(b,1/3));c++}},C:function(a){var c,b,d=a.slice(0),e=this.n,f=this.a,g=e[0],h=e[1],k=e[2],l=e[3],m=e[4],n=e[5],p=e[6],q=e[7];for(a=0;64>a;a++)16>a?c=d[a]:(c=d[a+1&15],b=d[a+14&15],c=d[a&15]=(c>>>7^c>>>18^c>>>3^
c<<25^c<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+d[a&15]+d[a+9&15]|0),c=c+q+(m>>>6^m>>>11^m>>>25^m<<26^m<<21^m<<7)+(p^m&(n^p))+f[a],q=p,p=n,n=m,m=l+c|0,l=k,k=h,h=g,g=c+(h&k^l&(h^k))+(h>>>2^h>>>13^h>>>22^h<<30^h<<19^h<<10)|0;e[0]=e[0]+g|0;e[1]=e[1]+h|0;e[2]=e[2]+k|0;e[3]=e[3]+l|0;e[4]=e[4]+m|0;e[5]=e[5]+n|0;e[6]=e[6]+p|0;e[7]=e[7]+q|0}};
sjcl.mode.ccm={name:"ccm",encrypt:function(a,c,b,d,e){var f,g=c.slice(0),h=sjcl.bitArray,k=h.bitLength(b)/8,l=h.bitLength(g)/8;e=e||64;d=d||[];if(7>k)throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");for(f=2;4>f&&l>>>8*f;f++);f<15-k&&(f=15-k);b=h.clamp(b,8*(15-f));c=sjcl.mode.ccm.G(a,c,b,d,e,f);g=sjcl.mode.ccm.I(a,g,b,c,e,f);return h.concat(g.data,g.tag)},decrypt:function(a,c,b,d,e){e=e||64;d=d||[];var f=sjcl.bitArray,g=f.bitLength(b)/8,h=f.bitLength(c),k=f.clamp(c,h-e),l=f.bitSlice(c,
h-e),h=(h-e)/8;if(7>g)throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");for(c=2;4>c&&h>>>8*c;c++);c<15-g&&(c=15-g);b=f.clamp(b,8*(15-c));k=sjcl.mode.ccm.I(a,k,b,l,e,c);a=sjcl.mode.ccm.G(a,k.data,b,d,e,c);if(!f.equal(k.tag,a))throw new sjcl.exception.corrupt("ccm: tag doesn't match");return k.data},G:function(a,c,b,d,e,f){var g=[],h=sjcl.bitArray,k=h.k;e/=8;if(e%2||4>e||16<e)throw new sjcl.exception.invalid("ccm: invalid tag length");if(4294967295<d.length||4294967295<c.length)throw new sjcl.exception.bug("ccm: can't deal with 4GiB or more data");
f=[h.partial(8,(d.length?64:0)|e-2<<2|f-1)];f=h.concat(f,b);f[3]|=h.bitLength(c)/8;f=a.encrypt(f);if(d.length){b=h.bitLength(d)/8;65279>=b?g=[h.partial(16,b)]:4294967295>=b&&(g=h.concat([h.partial(16,65534)],[b]));g=h.concat(g,d);for(d=0;d<g.length;d+=4)f=a.encrypt(k(f,g.slice(d,d+4).concat([0,0,0])))}for(d=0;d<c.length;d+=4)f=a.encrypt(k(f,c.slice(d,d+4).concat([0,0,0])));return h.clamp(f,8*e)},I:function(a,c,b,d,e,f){var g,h=sjcl.bitArray;g=h.k;var k=c.length,l=h.bitLength(c);b=h.concat([h.partial(8,
f-1)],b).concat([0,0,0]).slice(0,4);d=h.bitSlice(g(d,a.encrypt(b)),0,e);if(!k)return{tag:d,data:[]};for(g=0;g<k;g+=4)b[3]++,e=a.encrypt(b),c[g]^=e[0],c[g+1]^=e[1],c[g+2]^=e[2],c[g+3]^=e[3];return{tag:d,data:h.clamp(c,l)}}};
sjcl.mode.ocb2={name:"ocb2",encrypt:function(a,c,b,d,e,f){if(128!==sjcl.bitArray.bitLength(b))throw new sjcl.exception.invalid("ocb iv must be 128 bits");var g,h=sjcl.mode.ocb2.A,k=sjcl.bitArray,l=k.k,m=[0,0,0,0];b=h(a.encrypt(b));var n,p=[];d=d||[];e=e||64;for(g=0;g+4<c.length;g+=4)n=c.slice(g,g+4),m=l(m,n),p=p.concat(l(b,a.encrypt(l(b,n)))),b=h(b);n=c.slice(g);c=k.bitLength(n);g=a.encrypt(l(b,[0,0,0,c]));n=k.clamp(l(n.concat([0,0,0]),g),c);m=l(m,l(n.concat([0,0,0]),g));m=a.encrypt(l(m,l(b,h(b))));
d.length&&(m=l(m,f?d:sjcl.mode.ocb2.pmac(a,d)));return p.concat(k.concat(n,k.clamp(m,e)))},decrypt:function(a,c,b,d,e,f){if(128!==sjcl.bitArray.bitLength(b))throw new sjcl.exception.invalid("ocb iv must be 128 bits");e=e||64;var g=sjcl.mode.ocb2.A,h=sjcl.bitArray,k=h.k,l=[0,0,0,0],m=g(a.encrypt(b)),n,p,q=sjcl.bitArray.bitLength(c)-e,r=[];d=d||[];for(b=0;b+4<q/32;b+=4)n=k(m,a.decrypt(k(m,c.slice(b,b+4)))),l=k(l,n),r=r.concat(n),m=g(m);p=q-32*b;n=a.encrypt(k(m,[0,0,0,p]));n=k(n,h.clamp(c.slice(b),p).concat([0,
0,0]));l=k(l,n);l=a.encrypt(k(l,k(m,g(m))));d.length&&(l=k(l,f?d:sjcl.mode.ocb2.pmac(a,d)));if(!h.equal(h.clamp(l,e),h.bitSlice(c,q)))throw new sjcl.exception.corrupt("ocb: tag doesn't match");return r.concat(h.clamp(n,p))},pmac:function(a,c){var b,d=sjcl.mode.ocb2.A,e=sjcl.bitArray,f=e.k,g=[0,0,0,0],h=a.encrypt([0,0,0,0]),h=f(h,d(d(h)));for(b=0;b+4<c.length;b+=4)h=d(h),g=f(g,a.encrypt(f(h,c.slice(b,b+4))));c=c.slice(b);128>e.bitLength(c)&&(h=f(h,d(h)),c=e.concat(c,[-2147483648,0,0,0]));g=f(g,c);
return a.encrypt(f(d(f(h,d(h))),g))},A:function(a){return[a[0]<<1^a[1]>>>31,a[1]<<1^a[2]>>>31,a[2]<<1^a[3]>>>31,a[3]<<1^135*(a[0]>>>31)]}};sjcl.misc.hmac=function(a,c){this.M=c=c||sjcl.hash.sha256;var b=[[],[]],d=c.prototype.blockSize/32;this.l=[new c,new c];a.length>d&&(a=c.hash(a));for(c=0;c<d;c++)b[0][c]=a[c]^909522486,b[1][c]=a[c]^1549556828;this.l[0].update(b[0]);this.l[1].update(b[1])};
sjcl.misc.hmac.prototype.encrypt=sjcl.misc.hmac.prototype.mac=function(a,c){a=(new this.M(this.l[0])).update(a,c).finalize();return(new this.M(this.l[1])).update(a).finalize()};
sjcl.misc.pbkdf2=function(a,c,b,d,e){b=b||1E3;if(0>d||0>b)throw sjcl.exception.invalid("invalid params to pbkdf2");"string"===typeof a&&(a=sjcl.codec.utf8String.toBits(a));e=e||sjcl.misc.hmac;a=new e(a);var f,g,h,k,l=[],m=sjcl.bitArray;for(k=1;32*l.length<(d||1);k++){e=f=a.encrypt(m.concat(c,[k]));for(g=1;g<b;g++){f=a.encrypt(f);for(h=0;h<f.length;h++)e[h]^=f[h]}l=l.concat(e)}d&&(l=m.clamp(l,d));return l};
sjcl.random={randomWords:function(a,c){var b=[];c=this.isReady(c);var d;if(0===c)throw new sjcl.exception.notReady("generator isn't seeded");c&2&&this.U(!(c&1));for(c=0;c<a;c+=4)0===(c+1)%65536&&this.L(),d=this.u(),b.push(d[0],d[1],d[2],d[3]);this.L();return b.slice(0,a)},setDefaultParanoia:function(a){this.t=a},addEntropy:function(a,c,b){b=b||"user";var d,e,f=(new Date).valueOf(),g=this.q[b],h=this.isReady();d=this.F[b];void 0===d&&(d=this.F[b]=this.R++);void 0===g&&(g=this.q[b]=0);this.q[b]=(this.q[b]+
1)%this.b.length;switch(typeof a){case "number":break;case "object":if(void 0===c)for(b=c=0;b<a.length;b++)for(e=a[b];0<e;)c++,e>>>=1;this.b[g].update([d,this.J++,2,c,f,a.length].concat(a));break;case "string":void 0===c&&(c=a.length);this.b[g].update([d,this.J++,3,c,f,a.length]);this.b[g].update(a);break;default:throw new sjcl.exception.bug("random: addEntropy only supports number, array or string");}this.j[g]+=c;this.f+=c;0===h&&(0!==this.isReady()&&this.K("seeded",Math.max(this.g,this.f)),this.K("progress",
this.getProgress()))},isReady:function(a){a=this.B[void 0!==a?a:this.t];return this.g&&this.g>=a?80<this.j[0]&&(new Date).valueOf()>this.O?3:1:this.f>=a?2:0},getProgress:function(a){a=this.B[a?a:this.t];return this.g>=a?1["0"]:this.f>a?1["0"]:this.f/a},startCollectors:function(){if(!this.m){if(window.addEventListener)window.addEventListener("load",this.o,!1),window.addEventListener("mousemove",this.p,!1);else if(document.attachEvent)document.attachEvent("onload",this.o),document.attachEvent("onmousemove",
this.p);else throw new sjcl.exception.bug("can't attach event");this.m=!0}},stopCollectors:function(){this.m&&(window.removeEventListener?(window.removeEventListener("load",this.o,!1),window.removeEventListener("mousemove",this.p,!1)):window.detachEvent&&(window.detachEvent("onload",this.o),window.detachEvent("onmousemove",this.p)),this.m=!1)},addEventListener:function(a,c){this.r[a][this.Q++]=c},removeEventListener:function(a,c){var b;a=this.r[a];var d=[];for(b in a)a.hasOwnProperty(b)&&a[b]===c&&
d.push(b);for(c=0;c<d.length;c++)b=d[c],delete a[b]},b:[new sjcl.hash.sha256],j:[0],z:0,q:{},J:0,F:{},R:0,g:0,f:0,O:0,a:[0,0,0,0,0,0,0,0],d:[0,0,0,0],s:void 0,t:6,m:!1,r:{progress:{},seeded:{}},Q:0,B:[0,48,64,96,128,192,256,384,512,768,1024],u:function(){for(var a=0;4>a&&!(this.d[a]=this.d[a]+1|0,this.d[a]);a++);return this.s.encrypt(this.d)},L:function(){this.a=this.u().concat(this.u());this.s=new sjcl.cipher.aes(this.a)},T:function(a){this.a=sjcl.hash.sha256.hash(this.a.concat(a));this.s=new sjcl.cipher.aes(this.a);
for(a=0;4>a&&!(this.d[a]=this.d[a]+1|0,this.d[a]);a++);},U:function(a){var c=[],b=0,d;this.O=c[0]=(new Date).valueOf()+3E4;for(d=0;16>d;d++)c.push(4294967296*Math.random()|0);for(d=0;d<this.b.length&&!(c=c.concat(this.b[d].finalize()),b+=this.j[d],this.j[d]=0,!a&&this.z&1<<d);d++);this.z>=1<<this.b.length&&(this.b.push(new sjcl.hash.sha256),this.j.push(0));this.f-=b;b>this.g&&(this.g=b);this.z++;this.T(c)},p:function(a){sjcl.random.addEntropy([a.x||a.clientX||a.offsetX,a.y||a.clientY||a.offsetY],
2,"mouse")},o:function(){sjcl.random.addEntropy(new Date,2,"loadtime")},K:function(a,c){var b;a=sjcl.random.r[a];var d=[];for(b in a)a.hasOwnProperty(b)&&d.push(a[b]);for(b=0;b<d.length;b++)d[b](c)}};try{var s=new Uint32Array(32);crypto.getRandomValues(s);sjcl.random.addEntropy(s,1024,"crypto['getRandomValues']")}catch(t){}
sjcl.json={defaults:{v:1,iter:1E3,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},encrypt:function(a,c,b,d){b=b||{};d=d||{};var e=sjcl.json,f=e.c({iv:sjcl.random.randomWords(4,0)},e.defaults);e.c(f,b);"string"===typeof f.salt&&(f.salt=sjcl.codec.base64.toBits(f.salt));"string"===typeof f.iv&&(f.iv=sjcl.codec.base64.toBits(f.iv));if(!sjcl.mode[f.mode]||!sjcl.cipher[f.cipher]||"string"===typeof a&&100>=f.iter||64!==f.ts&&96!==f.ts&&128!==f.ts||128!==f.ks&&192!==f.ks&&256!==f.ks||2>f.iv.length||4<f.iv.length)throw new sjcl.exception.invalid("json encrypt: invalid parameters");
"string"===typeof a&&(b=sjcl.misc.cachedPbkdf2(a,f),a=b.key.slice(0,f.ks/32),f.salt=b.salt);"string"===typeof c&&(c=sjcl.codec.utf8String.toBits(c));b=new sjcl.cipher[f.cipher](a);e.c(d,f);d.key=a;f.ct=sjcl.mode[f.mode].encrypt(b,c,f.iv,f.adata,f.ts);return e.encode(e.V(f,e.defaults))},decrypt:function(a,c,b,d){b=b||{};d=d||{};var e=sjcl.json;c=e.c(e.c(e.c({},e.defaults),e.decode(c)),b,!0);"string"===typeof c.salt&&(c.salt=sjcl.codec.base64.toBits(c.salt));"string"===typeof c.iv&&(c.iv=sjcl.codec.base64.toBits(c.iv));
if(!sjcl.mode[c.mode]||!sjcl.cipher[c.cipher]||"string"===typeof a&&100>=c.iter||64!==c.ts&&96!==c.ts&&128!==c.ts||128!==c.ks&&192!==c.ks&&256!==c.ks||!c.iv||2>c.iv.length||4<c.iv.length)throw new sjcl.exception.invalid("json decrypt: invalid parameters");"string"===typeof a&&(b=sjcl.misc.cachedPbkdf2(a,c),a=b.key.slice(0,c.ks/32),c.salt=b.salt);b=new sjcl.cipher[c.cipher](a);b=sjcl.mode[c.mode].decrypt(b,c.ct,c.iv,c.adata,c.ts);e.c(d,c);d.key=a;return sjcl.codec.utf8String.fromBits(b)},encode:function(a){var c,
b="{",d="";for(c in a)if(a.hasOwnProperty(c)){if(!c.match(/^[a-z0-9]+$/i))throw new sjcl.exception.invalid("json encode: invalid property name");b+=d+c+":";d=",";switch(typeof a[c]){case "number":case "boolean":b+=a[c];break;case "string":b+='"'+escape(a[c])+'"';break;case "object":b+='"'+sjcl.codec.base64.fromBits(a[c],1)+'"';break;default:throw new sjcl.exception.bug("json encode: unsupported type");}}return b+"}"},decode:function(a){a=a.replace(/\s/g,"");if(!a.match(/^\{.*\}$/))throw new sjcl.exception.invalid("json decode: this isn't json!");
a=a.replace(/^\{|\}$/g,"").split(/,/);var c={},b,d;for(b=0;b<a.length;b++){if(!(d=a[b].match(/^([a-z][a-z0-9]*):(?:(\d+)|"([a-z0-9+\/%*_.@=\-]*)")$/i)))throw new sjcl.exception.invalid("json decode: this isn't json!");c[d[1]]=d[2]?parseInt(d[2],10):d[1].match(/^(ct|salt|iv)$/)?sjcl.codec.base64.toBits(d[3]):unescape(d[3])}return c},c:function(a,c,b){void 0===a&&(a={});if(void 0===c)return a;for(var d in c)if(c.hasOwnProperty(d)){if(b&&void 0!==a[d]&&a[d]!==c[d])throw new sjcl.exception.invalid("required parameter overridden");
a[d]=c[d]}return a},V:function(a,c){var b={},d;for(d in a)a.hasOwnProperty(d)&&a[d]!==c[d]&&(b[d]=a[d]);return b},W:function(a,c){var b={},d;for(d=0;d<c.length;d++)void 0!==a[c[d]]&&(b[c[d]]=a[c[d]]);return b}};sjcl.encrypt=sjcl.json.encrypt;sjcl.decrypt=sjcl.json.decrypt;sjcl.misc.S={};
sjcl.misc.cachedPbkdf2=function(a,c){var b=sjcl.misc.S,d;c=c||{};d=c.iter||1E3;b=b[a]=b[a]||{};d=b[d]=b[d]||{firstSalt:c.salt&&c.salt.length?c.salt.slice(0):sjcl.random.randomWords(2,0)};b=void 0===c.salt?d.firstSalt:c.salt;d[b]=d[b]||sjcl.misc.pbkdf2(a,b,c.iter);return{key:d[b].slice(0),salt:b.slice(0)}};module.exports=sjcl;function string_to_array(a){for(var c=a.length,b=Array(c),d=0;d<c;d++)b[d]=a.charCodeAt(d);return b}
function array_to_hex_string(a){for(var c="",b=0;b<a.length;b++)c+=SHA256_hexchars[a[b]>>4]+SHA256_hexchars[a[b]&15];return c}var SHA256_buf,SHA256_H,SHA256_len;function SHA256_init(){SHA256_H=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225];SHA256_buf=[];SHA256_len=0}
function SHA256_write(a){SHA256_buf="string"==typeof a?SHA256_buf.concat(string_to_array(a)):SHA256_buf.concat(a);for(var c=0;c+64<=SHA256_buf.length;c+=64)SHA256_Hash_Byte_Block(SHA256_H,SHA256_buf.slice(c,c+64));SHA256_buf=SHA256_buf.slice(c);SHA256_len+=a.length}
function SHA256_finalize(){SHA256_buf[SHA256_buf.length]=128;if(56<SHA256_buf.length){for(var a=SHA256_buf.length;64>a;a++)SHA256_buf[a]=0;SHA256_Hash_Byte_Block(SHA256_H,SHA256_buf);SHA256_buf.length=0}for(a=SHA256_buf.length;59>a;a++)SHA256_buf[a]=0;SHA256_buf[59]=SHA256_len>>>29&255;SHA256_buf[60]=SHA256_len>>>21&255;SHA256_buf[61]=SHA256_len>>>13&255;SHA256_buf[62]=SHA256_len>>>5&255;SHA256_buf[63]=SHA256_len<<3&255;SHA256_Hash_Byte_Block(SHA256_H,SHA256_buf);for(var c=Array(32),a=0;8>a;a++)c[4*
a+0]=SHA256_H[a]>>>24,c[4*a+1]=SHA256_H[a]>>16&255,c[4*a+2]=SHA256_H[a]>>8&255,c[4*a+3]=SHA256_H[a]&255;delete SHA256_H;delete SHA256_buf;delete SHA256_len;return c}function SHA256_hash(a){SHA256_init();SHA256_write(a);a=SHA256_finalize();return array_to_hex_string(a)}var HMAC_SHA256_key;
function HMAC_SHA256_init(a){HMAC_SHA256_key="string"==typeof a?string_to_array(a):[].concat(a);64<HMAC_SHA256_key.length&&(SHA256_init(),SHA256_write(HMAC_SHA256_key),HMAC_SHA256_key=SHA256_finalize());for(a=HMAC_SHA256_key.length;64>a;a++)HMAC_SHA256_key[a]=0;for(a=0;64>a;a++)HMAC_SHA256_key[a]^=54;SHA256_init();SHA256_write(HMAC_SHA256_key)}function HMAC_SHA256_write(a){SHA256_write(a)}
function HMAC_SHA256_finalize(){for(var a=SHA256_finalize(),c=0;64>c;c++)HMAC_SHA256_key[c]^=106;SHA256_init();SHA256_write(HMAC_SHA256_key);SHA256_write(a);for(c=0;64>c;c++)HMAC_SHA256_key[c]=0;delete HMAC_SHA256_key;return SHA256_finalize()}function HMAC_SHA256_MAC(a,c){var b;HMAC_SHA256_init(a);HMAC_SHA256_write(c);b=HMAC_SHA256_finalize();return array_to_hex_string(b)}SHA256_hexchars="0123456789abcdef".split("");
SHA256_K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,
4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function SHA256_sigma0(a){return(a>>>7|a<<25)^(a>>>18|a<<14)^a>>>3}function SHA256_sigma1(a){return(a>>>17|a<<15)^(a>>>19|a<<13)^a>>>10}function SHA256_Sigma0(a){return(a>>>2|a<<30)^(a>>>13|a<<19)^(a>>>22|a<<10)}function SHA256_Sigma1(a){return(a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7)}
function SHA256_Ch(a,c,b){return b^a&(c^b)}function SHA256_Maj(a,c,b){return a&c^b&(a^c)}function SHA256_Hash_Word_Block(a,c){for(var b=16;64>b;b++)c[b]=SHA256_sigma1(c[b-2])+c[b-7]+SHA256_sigma0(c[b-15])+c[b-16]&4294967295;for(var d=[].concat(a),b=0;64>b;b++){var e=d[7]+SHA256_Sigma1(d[4])+SHA256_Ch(d[4],d[5],d[6])+SHA256_K[b]+c[b],f=SHA256_Sigma0(d[0])+SHA256_Maj(d[0],d[1],d[2]);d.pop();d.unshift(e+f&4294967295);d[4]=d[4]+e&4294967295}for(b=0;8>b;b++)a[b]=a[b]+d[b]&4294967295}
function SHA256_Hash_Byte_Block(a,c){for(var b=Array(16),d=0;16>d;d++)b[d]=c[4*d+0]<<24|c[4*d+1]<<16|c[4*d+2]<<8|c[4*d+3];SHA256_Hash_Word_Block(a,b)}module.exports={init:HMAC_SHA256_init,update:HMAC_SHA256_write,finalize:HMAC_SHA256_finalize};var crypto=require("crypto"),sha256=require("./jssha256");
function pbkdf2(a,c,b,d,e){if(e>32*(Math.pow(2,32)-1))throw Error("Requested key length too long");var f=[],g=[],h=[],k=Math.ceil(e/32);e-=32*(k-1);arraycopy(c,0,h,0,c.length);for(var l=1;l<=k;l++){h[c.length+0]=l>>24&255;h[c.length+1]=l>>16&255;h[c.length+2]=l>>8&255;h[c.length+3]=l>>0&255;sha256.init(a);sha256.update(h);f=sha256.finalize();arraycopy(f,0,g,0,32);for(var m=1;m<b;m++){sha256.update(f);for(var f=sha256.finalize(),n=0;32>n;n++)g[n]^=f[n]}arraycopy(g,0,d,32*(l-1),l==k?e:32)}}
function arraycopy(a,c,b,d,e){for(;e--;)b[d++]=a[c++]}module.exports=pbkdf2;